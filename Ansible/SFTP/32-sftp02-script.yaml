- name: Deploy SFTP Scan Worker on RHEL
  hosts: sftp-02
  become: true
  vars:
    upload_base: "/srv/efs/sftp/uploads"
    download_base: "/srv/efs/sftp/downloads"
    processed_base: "/srv/efs/sftp/processed"
    processing_base: "/srv/efs/sftp/processing"
    log_file: "/var/log/sftp_scan.log"
    script_path: "/usr/local/bin/scan.sh"
    service_name: "sftp-scan.service"
    timer_name: "sftp-scan.timer"
    stable_seconds: 60

  tasks:

    - name: Ensure log file exists
      file:
        path: "{{ log_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'

    - name: Deploy SFTP scan script
      copy:
        dest: "{{ script_path }}"
        mode: '0755'
        content: |
          #!/bin/bash
          set -euo pipefail

          UPLOAD_BASE="{{ upload_base }}"
          DOWNLOAD_BASE="{{ download_base }}"
          PROCESSED_BASE="{{ processed_base }}"
          PROCESSING_BASE="{{ processing_base }}"
          LOG="{{ log_file }}"
          STABLE_SECONDS={{ stable_seconds }}
          LOCKFILE="/var/run/sftp_scan.lock"

          exec 9>"$LOCKFILE" || exit 1
          flock -n 9 || exit 0

          log() {
            echo "[$(date '+%F %T')] $*" >> "$LOG"
          }

          is_stable() {
            local file="$1"
            local mtime
            mtime=$(stat -c %Y "$file")
            (( $(date +%s) - mtime > STABLE_SECONDS ))
          }

          for system_dir in "$UPLOAD_BASE"/*; do
            [ -d "$system_dir" ] || continue
            system=$(basename "$system_dir")

            mkdir -p \
              "$PROCESSING_BASE/$system" \
              "$DOWNLOAD_BASE/$system" \
              "$PROCESSED_BASE/$system"

            for file in "$system_dir"/*; do
              [ -f "$file" ] || continue
              if ! is_stable "$file"; then
                continue
              fi

              fname=$(basename "$file")
              work="$PROCESSING_BASE/$system/$fname"

              if ! mv "$file" "$work" 2>/dev/null; then
                continue
              fi

              log "$system: picked up $fname"

              ts=$(date '+%Y%m%d%H%M%S')
              archive="$PROCESSED_BASE/$system/${fname}.${ts}.tar.gz"

              if tar -czf "$archive" -C "$PROCESSING_BASE/$system" "$fname"; then
                log "$system: archived $fname"
              else
                log "ERROR: archive failed $fname"
                mv "$work" "$system_dir/" || true
                continue
              fi

              if mv "$work" "$DOWNLOAD_BASE/$system/$fname"; then
                log "$system: delivered $fname"
              else
                log "ERROR: move failed $fname"
                mv "$work" "$system_dir/" || true
              fi
            done
          done

    - name: Deploy systemd service file
      copy:
        dest: "/etc/systemd/system/{{ service_name }}"
        mode: '0644'
        content: |
          [Unit]
          Description=SFTP Scan Worker
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          ExecStart={{ script_path }}
          StandardOutput=journal
          StandardError=journal

    - name: Deploy systemd timer file
      copy:
        dest: "/etc/systemd/system/{{ timer_name }}"
        mode: '0644'
        content: |
          [Unit]
          Description=Run SFTP Scan periodically

          [Timer]
          OnUnitActiveSec=1min
          Persistent=true

          [Install]
          WantedBy=timers.target

    - name: Reload systemd daemon
      command: systemctl daemon-reload

    - name: Enable and start SFTP scan timer
      systemd:
        name: "{{ timer_name }}"
        enabled: yes
        state: started
